# bot/admin/inspection_admin.py
from vkbottle.bot import BotLabeler, Message
from vkbottle import API
from datetime import datetime, timedelta

from bot.core.config import settings
from bot.db import set_inspection_time_mode, get_inspection_time_mode
from bot.services.users import is_admin

admin_labeler = BotLabeler()
admin_labeler.vbml_ignore_case = True

# ======================
# –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –†–ê–°–°–´–õ–ö–ò –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –ò–ì–†–û–ö–ê–ú
# ======================

async def notify_all_players(message_text: str):
    """–û–ø–æ–≤–µ—Å—Ç–∏—Ç—å –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞"""
    # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ –ë–î
    # –∏ —Ä–∞—Å—Å—ã–ª–∫–∏ –∏–º —Å–æ–æ–±—â–µ–Ω–∏–π
    # –≠—Ç–æ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è - –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö user_id
    try:
        api = API(token=settings.VK_TOKEN)
        
        # –ü—Ä–∏–º–µ—Ä –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ (–Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å)
        # all_players = await get_all_players() 
        
        # –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –ø—Ä–æ—Å—Ç–æ –≤—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å
        print(f"üì¢ –û–ø–æ–≤–µ—â–µ–Ω–∏–µ: {message_text}")
        
        # –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞
        # for player in all_players:
        #     try:
        #         await api.messages.send(
        #             peer_id=player["user_id"],
        #             message=message_text,
        #             random_id=0
        #         )
        #     except:
        #         continue
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—Å—ã–ª–∫–µ: {e}")

# ======================
# –ê–î–ú–ò–ù-–ö–û–ú–ê–ù–î–ê: –í–ö–õ–Æ–ß–ò–¢–¨ –†–ï–ñ–ò–ú "–í–†–ï–ú–Ø –ü–†–û–í–ï–†–û–ö"
# ======================

@admin_labeler.message(text=["–≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–æ–∫ <hours>", "/–≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–æ–∫ <hours>"])
async def enable_inspection_mode_handler(message: Message, hours: str):
    """–í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º '–í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–æ–∫' (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)"""
    user_id = message.from_id
    
    # –ü–†–û–í–ï–†–ö–ê –ü–†–ê–í –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê
    if not await is_admin(user_id):
        return "‚õî –î–û–°–¢–£–ü –ó–ê–ü–†–ï–©–ï–ù\n\n–î–∞–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞!"
    
    try:
        duration = int(hours)
        if duration <= 0:
            return "‚ùå –û–®–ò–ë–ö–ê\n\n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º!"
        
        if duration > 48:
            return "‚ùå –û–®–ò–ë–ö–ê\n\n–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–µ–∂–∏–º–∞ - 48 —á–∞—Å–æ–≤!"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ —É–∂–µ —Ä–µ–∂–∏–º
        current_mode = await get_inspection_time_mode()
        if current_mode["is_active"]:
            ends_at = datetime.fromisoformat(current_mode["ends_at"])
            time_left = ends_at - datetime.now()
            hours_left = time_left.seconds // 3600
            return (
                f"‚ö†Ô∏è –†–ï–ñ–ò–ú –£–ñ–ï –ê–ö–¢–ò–í–ï–ù\n\n"
                f"–†–µ–∂–∏–º '–í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–æ–∫' —É–∂–µ –∑–∞–ø—É—â–µ–Ω!\n\n"
                f"‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: {hours_left} —á–∞—Å–æ–≤\n"
                f"üïê –ó–∞–≤–µ—Ä—à–∏—Ç—Å—è: {ends_at.strftime('%H:%M %d.%m')}\n\n"
                f"–°–Ω–∞—á–∞–ª–∞ –≤—ã–∫–ª—é—á–∏—Ç–µ —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º –∫–æ–º–∞–Ω–¥–æ–π:\n"
                f"/–≤—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞"
            )
        
        # –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º
        success = await set_inspection_time_mode(True, duration)
        
        if not success:
            return "‚ùå –û–®–ò–ë–ö–ê\n\n–ù–µ —É–¥–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
        mode_info = await get_inspection_time_mode()
        ends_at = datetime.fromisoformat(mode_info["ends_at"])
        ends_at_formatted = ends_at.strftime("%d.%m.%Y %H:%M")
        
        # –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        admin_message = (
            f"‚ö° –†–ï–ñ–ò–ú '–í–†–ï–ú–Ø –ü–†–û–í–ï–†–û–ö' –ê–ö–¢–ò–í–ò–†–û–í–ê–ù\n\n"
            f"üëë –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º [id{user_id}|{message.from_id}]\n\n"
            f"üéØ –ù–ê–°–¢–†–û–ô–ö–ò –†–ï–ñ–ò–ú–ê:\n"
            f"‚è±Ô∏è –ö–î –ø—Ä–æ–≤–µ—Ä–æ–∫: 30 –º–∏–Ω—É—Ç\n"
            f"üìä –õ–∏–º–∏—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫: 24/—Å—É—Ç–∫–∏\n"
            f"üí∞ –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è: 6 –º–æ–Ω–µ—Ç/–∑–∞–ª\n"
            f"üõ°Ô∏è –ó–∞—â–∏—Ç—ã: –û–¢–ö–õ–Æ–ß–ï–ù–´\n\n"
            f"‚è≥ –†–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω –¥–æ: {ends_at_formatted}\n"
            f"üïê –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration} —á–∞—Å–æ–≤"
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞–¥–º–∏–Ω—É
        await message.answer(admin_message)
        
        # –û–ø–æ–≤–µ—â–∞–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
        player_notification = (
            f"‚ö° –í–ù–ò–ú–ê–ù–ò–ï! –†–ï–ñ–ò–ú '–í–†–ï–ú–Ø –ü–†–û–í–ï–†–û–ö' –ê–ö–¢–ò–í–ò–†–û–í–ê–ù\n\n"
            f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–ø—É—Å—Ç–∏–ª–∞ —Ä–µ–∂–∏–º —É—Å–∏–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –Ω–∞ {duration} —á–∞—Å–æ–≤!\n\n"
            f"üéØ –ù–ê {duration} –ß–ê–°–û–í:\n"
            f"‚è±Ô∏è –ö–î –ø—Ä–æ–≤–µ—Ä–æ–∫: 30 –º–∏–Ω—É—Ç\n"
            f"üìä –õ–∏–º–∏—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫: 24/—Å—É—Ç–∫–∏\n"
            f"üí∞ –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è: 6 –º–æ–Ω–µ—Ç/–∑–∞–ª\n"
            f"üõ°Ô∏è –ó–∞—â–∏—Ç—ã: –ù–ï –†–ê–ë–û–¢–ê–Æ–¢\n\n"
            f"–ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã! üõ°Ô∏è"
        )
        await notify_all_players(player_notification)
        
    except ValueError:
        return "‚ùå –û–®–ò–ë–ö–ê\n\n–ß–∞—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–æ–º!\n\n–ü—Ä–∏–º–µ—Ä: /–≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–æ–∫ 24"

# ======================
# –ê–î–ú–ò–ù-–ö–û–ú–ê–ù–î–ê: –í–´–ö–õ–Æ–ß–ò–¢–¨ –†–ï–ñ–ò–ú "–í–†–ï–ú–Ø –û–¢–î–´–•–ê"
# ======================

@admin_labeler.message(text=["–≤—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞", "/–≤—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞"])
async def disable_inspection_mode_handler(message: Message):
    """–í—ã–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º '–í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–æ–∫' (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)"""
    user_id = message.from_id
    
    # –ü–†–û–í–ï–†–ö–ê –ü–†–ê–í –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê
    if not await is_admin(user_id):
        return "‚õî –î–û–°–¢–£–ü –ó–ê–ü–†–ï–©–ï–ù\n\n–î–∞–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞!"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ —Ä–µ–∂–∏–º
    current_mode = await get_inspection_time_mode()
    if not current_mode["is_active"]:
        return "‚ÑπÔ∏è –ò–ù–§–û–†–ú–ê–¶–ò–Ø\n\n–†–µ–∂–∏–º '–í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–æ–∫' –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω."
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–æ –≤—ã–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    ends_at = datetime.fromisoformat(current_mode["ends_at"]) if current_mode["ends_at"] else None
    
    # –í—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º
    success = await set_inspection_time_mode(False)
    
    if not success:
        return "‚ùå –û–®–ò–ë–ö–ê\n\n–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
    
    # –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    admin_message = (
        f"üåô –†–ï–ñ–ò–ú '–í–†–ï–ú–Ø –û–¢–î–´–•–ê' –ê–ö–¢–ò–í–ò–†–û–í–ê–ù\n\n"
        f"üëë –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º [id{user_id}|{message.from_id}]\n\n"
        f"üéØ –í–û–ó–í–†–ê–©–ï–ù–´ –û–ë–´–ß–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò:\n"
        f"‚è±Ô∏è –ö–î –ø—Ä–æ–≤–µ—Ä–æ–∫: 1 —á–∞—Å\n"
        f"üìä –õ–∏–º–∏—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫: 10/—Å—É—Ç–∫–∏\n"
        f"üí∞ –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è: 3 –º–æ–Ω–µ—Ç—ã/–∑–∞–ª\n"
        f"üõ°Ô∏è –ó–∞—â–∏—Ç—ã: –ê–ö–¢–ò–í–ù–´"
    )
    
    if ends_at:
        time_passed = datetime.now() - ends_at + timedelta(hours=24)  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—á–µ—Ç
        admin_message += f"\n\nüìä –†–µ–∂–∏–º –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–ª: {abs(time_passed.seconds // 3600)} —á–∞—Å–æ–≤"
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞–¥–º–∏–Ω—É
    await message.answer(admin_message)
    
    # –û–ø–æ–≤–µ—â–∞–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
    player_notification = (
        f"üåô –†–ï–ñ–ò–ú '–í–†–ï–ú–Ø –û–¢–î–´–•–ê'\n\n"
        f"–†–µ–∂–∏–º —É—Å–∏–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω!\n\n"
        f"üéØ –í–û–ó–í–†–ê–©–ï–ù–´ –û–ë–´–ß–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò:\n"
        f"‚è±Ô∏è –ö–î –ø—Ä–æ–≤–µ—Ä–æ–∫: 1 —á–∞—Å\n"
        f"üìä –õ–∏–º–∏—Ç: 10/—Å—É—Ç–∫–∏\n"
        f"üí∞ –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è: 3 –º–æ–Ω–µ—Ç—ã/–∑–∞–ª\n"
        f"üõ°Ô∏è –ó–∞—â–∏—Ç—ã: –°–ù–û–í–ê –†–ê–ë–û–¢–ê–Æ–¢\n\n"
        f"–ú–æ–∂–Ω–æ –≤—ã–¥–æ—Ö–Ω—É—Ç—å... –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞–∑–∞ üòâ"
    )
    await notify_all_players(player_notification)

# ======================
# –ê–î–ú–ò–ù-–ö–û–ú–ê–ù–î–ê: –ü–†–û–í–ï–†–ò–¢–¨ –°–¢–ê–¢–£–° –†–ï–ñ–ò–ú–ê
# ======================

@admin_labeler.message(text=["—Å—Ç–∞—Ç—É—Å —Ä–µ–∂–∏–º–∞", "/—Å—Ç–∞—Ç—É—Å —Ä–µ–∂–∏–º–∞"])
async def admin_mode_status_handler(message: Message):
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ä–µ–∂–∏–º–∞ (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤)"""
    user_id = message.from_id
    
    if not await is_admin(user_id):
        return "‚õî –î–û–°–¢–£–ü –ó–ê–ü–†–ï–©–ï–ù"
    
    mode_info = await get_inspection_time_mode()
    
    if mode_info["is_active"]:
        ends_at = datetime.fromisoformat(mode_info["ends_at"])
        time_left = ends_at - datetime.now()
        hours_left = time_left.seconds // 3600
        minutes_left = (time_left.seconds % 3600) // 60
        
        return (
            f"üìä –°–¢–ê–¢–£–° –†–ï–ñ–ò–ú–ê –ü–†–û–í–ï–†–û–ö\n\n"
            f"‚ö° –†–µ–∂–∏–º: –ê–ö–¢–ò–í–ï–ù\n"
            f"‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: {hours_left}—á {minutes_left}–º\n"
            f"üïê –ó–∞–≤–µ—Ä—à–∏—Ç—Å—è: {ends_at.strftime('%H:%M %d.%m')}\n\n"
            f"üéØ –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\n"
            f"‚è±Ô∏è –ö–î: 30 –º–∏–Ω\n"
            f"üìä –õ–∏–º–∏—Ç: 24/–¥–µ–Ω—å\n"
            f"üí∞ –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è: 6 –º–æ–Ω–µ—Ç\n"
            f"üõ°Ô∏è –ó–∞—â–∏—Ç—ã: –û–¢–ö–õ–Æ–ß–ï–ù–´"
        )
    else:
        return (
            f"üìä –°–¢–ê–¢–£–° –†–ï–ñ–ò–ú–ê –ü–†–û–í–ï–†–û–ö\n\n"
            f"üåô –†–µ–∂–∏–º: –ù–ï –ê–ö–¢–ò–í–ï–ù\n"
            f"üéØ –û–±—ã—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\n"
            f"‚è±Ô∏è –ö–î: 1 —á–∞—Å\n"
            f"üìä –õ–∏–º–∏—Ç: 10/–¥–µ–Ω—å\n"
            f"üí∞ –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è: 3 –º–æ–Ω–µ—Ç—ã\n"
            f"üõ°Ô∏è –ó–∞—â–∏—Ç—ã: –ê–ö–¢–ò–í–ù–´"
        )

# ======================
# –ê–î–ú–ò–ù-–ö–û–ú–ê–ù–î–ê: –ü–†–û–î–õ–ò–¢–¨ –†–ï–ñ–ò–ú
# ======================

@admin_labeler.message(text=["–ø—Ä–æ–¥–ª–∏—Ç—å —Ä–µ–∂–∏–º <hours>", "/–ø—Ä–æ–¥–ª–∏—Ç—å —Ä–µ–∂–∏–º <hours>"])
async def extend_inspection_mode_handler(message: Message, hours: str):
    """–ü—Ä–æ–¥–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)"""
    user_id = message.from_id
    
    if not await is_admin(user_id):
        return "‚õî –î–û–°–¢–£–ü –ó–ê–ü–†–ï–©–ï–ù"
    
    try:
        extra_hours = int(hours)
        if extra_hours <= 0:
            return "‚ùå –û–®–ò–ë–ö–ê\n\n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º!"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ —Ä–µ–∂–∏–º
        current_mode = await get_inspection_time_mode()
        if not current_mode["is_active"]:
            return "‚ùå –†–µ–∂–∏–º –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –≤–∫–ª—é—á–∏—Ç–µ –µ–≥–æ –∫–æ–º–∞–Ω–¥–æ–π /–≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–æ–∫"
        
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤–æ–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
        current_ends_at = datetime.fromisoformat(current_mode["ends_at"])
        new_ends_at = current_ends_at + timedelta(hours=extra_hours)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∂–∏–º
        success = await set_inspection_time_mode(True, 0)  # –≤—Ä–µ–º–µ–Ω–Ω–æ
        if success:
            # –ü—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î
            from bot.db.inspection import settings_collection
            await settings_collection.update_one(
                {"key": "inspection_mode"},
                {"$set": {"ends_at": new_ends_at.isoformat()}}
            )
        
        return (
            f"‚è±Ô∏è –†–ï–ñ–ò–ú –ü–†–û–î–õ–ï–ù\n\n"
            f"–†–µ–∂–∏–º '–í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–æ–∫' –ø—Ä–æ–¥–ª–µ–Ω –Ω–∞ {extra_hours} —á–∞—Å–æ–≤\n\n"
            f"üïê –ù–æ–≤–æ–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è: {new_ends_at.strftime('%H:%M %d.%m')}"
        )
        
    except ValueError:
        return "‚ùå –û–®–ò–ë–ö–ê\n\n–ß–∞—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–æ–º!"

# ======================
# –≠–ö–°–ü–û–†–¢
# ======================

__all__ = ["admin_labeler"]
